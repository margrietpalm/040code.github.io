<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/><style data-href="/commons.131b48b25a50eff60b34.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.15.19"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="hTmxqc lcZENV lfoWPa hPmQYh dANmgz brBAvj hpDnww bWPqAN gEMFDS eyJpws cmRrYK hwkicN iTdcdb jRHVYT kQWgFX itRnbT jNHeyA dDhPjG iinOhl hFicPH" data-styled-version="4.3.2">
/* sc-component-id: SideMenu__StyledBurgerMenu-uekpe8-0 */
.hTmxqc .bm-burger-button{position:fixed;width:36px;height:30px;left:36px;top:36px;} .hTmxqc .bm-burger-bars{background:#ffffff;} .hTmxqc .bm-cross-button{height:24px;width:24px;} .hTmxqc .bm-cross{background:#ffffff;} .hTmxqc .bm-menu{background:rgb(0,0,0,0.5);padding:2.5em 1em 0;font-size:1.15em;} .hTmxqc .bm-morph-shape{fill:#373a47;} .hTmxqc .bm-item-list{padding-top:2em;} .hTmxqc .bm-item{display:inline-block;padding:0.5em;} .hTmxqc .bm-overlay{background:rgba(0,0,0,0.3);}
/* sc-component-id: SideMenu__MenuLink-uekpe8-1 */
.lcZENV{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;border:0;margin:0;margin-right:0.5rem;padding-left:20px;padding-right:20px;min-width:42px;z-index:10;}
/* sc-component-id: Footer__FooterWrapper-sc-1oxe0wr-0 */
.hFicPH{text-align:left;padding-top:30px;padding-bottom:50px;background-color:rgba(32,35,42,0.85);color:#ffffff;padding-left:20px;padding-right:20px;margin:3.5em auto 0 0;} .hFicPH nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;} .hFicPH nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-bottom:1em;padding-right:1em;} .hFicPH a{color:#ffffff;font-weight:bold;} .hFicPH a:hover{color:#e8e8e8;border-bottom:1px dotted #e8e8e8;} .hFicPH .footer-col > p{margin:0;} .hFicPH .footer-title{margin:0 0 1rem;} .hFicPH .footer-item{padding:0.25rem 0;color:#ffffff;} .hFicPH .footer-heart{color:red;} .hFicPH .footer-item-text{padding:0.1rem 0;color:#ffffff;} .hFicPH .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;} @media (max-width:564px){.hFicPH .footer-col:first-child{width:100%;}}
/* sc-component-id: sc-global-3886539976 */
*{box-sizing:border-box;margin:0;padding:0;} body{font-family:"Lato",sans-serif;color:#222222cc;background-color:#e8e8e8;} img{max-width:100%;height:auto;vertical-align:middle;border:0;} a{-webkit-text-decoration:none;text-decoration:none;color:rgba(34,34,34,0.8);} ul,ol{padding-left:2em;margin:1em 0 0 0;}
/* sc-component-id: Commons__StyledLink-sc-1yiug1-0 */
.iinOhl{border-bottom:1px dotted rgba(162,162,162,0.8);} .iinOhl:hover{border-bottom-style:solid;}
/* sc-component-id: Commons__Text-sc-1yiug1-1 */
.dDhPjG{line-height:1.6;margin:1em 0 0 0;}
/* sc-component-id: Wrapper-aej7i5-0 */
.hwkicN{position:relative;border-radius:3px;width:80%;max-width:770px;border-bottom:1px solid #ebf2f6;word-wrap:break-word;background-color:#fff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);} @media (max-width:780px){.hwkicN{width:90%;padding:25px;}}
/* sc-component-id: Hero__HeroContainer-sc-1i1rqpz-0 */
.lfoWPa{position:relative;display:table;width:100%;height:340px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}
/* sc-component-id: Hero__TitleContainer-sc-1i1rqpz-1 */
.hPmQYh{display:table-cell;vertical-align:middle;text-align:center;width:100%;}
/* sc-component-id: Hero__LocationContainer-sc-1i1rqpz-2 */
.gEMFDS{display:table-footer-group;vertical-align:center;text-align:right;width:100%;}
/* sc-component-id: Hero__HeroTitle-sc-1i1rqpz-3 */
.dANmgz{font-size:3.5rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-weight:800;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__HeroSubtitle-sc-1i1rqpz-4 */
.brBAvj{font-size:1.7rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__DateAndAuthor-sc-1i1rqpz-5 */
.hpDnww{font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;}
/* sc-component-id: Hero__AuthorLink-sc-1i1rqpz-6 */
.bWPqAN{margin-left:0.3rem;font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;} .bWPqAN:hover{border-bottom:1px dotted #787676;} .bWPqAN:before{content:'@';}
/* sc-component-id: Hero__LocationLink-sc-1i1rqpz-7 */
.cmRrYK{margin-right:0.7rem;font-size:0.9rem;color:#fff;text-shadow:2px 2px #222222;font-size:1rem;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;font-style:italic;} .cmRrYK:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: Hero__LocationMarker-sc-1i1rqpz-8 */
.eyJpws{margin-right:0.4rem;font-size:0.75rem;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: TagList__ListContainer-sc-1uj42o2-0 */
.kQWgFX{display:inline;margin:0 0.5rem 0 0;color:#787676;}
/* sc-component-id: TagList__TagListItem-sc-1uj42o2-1 */
.itRnbT{margin-left:0.3rem;display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#777;border-radius:10px;} .itRnbT:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: ContentHeader__Header-sc-1uw779c-0 */
.jRHVYT{margin-bottom:2rem;color:#787676;}
/* sc-component-id: Content__ContentBody-sc-1jppj8x-0 */
.jNHeyA{line-height:1.6;} .jNHeyA > *:first-child{padding-top:0;margin-top:0;} .jNHeyA > h1{margin-top:3rem;font-size:2em;} .jNHeyA > h2{margin-top:3rem;font-size:1.5em;} .jNHeyA > h3{padding-top:3rem;font-size:1.17em;} .jNHeyA > p{margin:1em 0 0 0;} .jNHeyA a{border-bottom:1px dotted rgba(162,162,162,0.8);} .jNHeyA a:hover{border-bottom-style:solid;} .jNHeyA a.anchor,.jNHeyA a.gatsby-resp-image-link{border:none;} .jNHeyA > blockquote{box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:0.4em solid rgba(32,35,42,0.85);} .jNHeyA > blockquote p{margin:0.8em 0;font-style:italic;} .jNHeyA .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;background:#2d2d2d;color:#ffffff;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em 0em 1.5em 0;font-size:0.7em;} .jNHeyA .gatsby-highlight > pre{border:0;margin:0;padding:1;} .jNHeyA .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffa7c4;} .jNHeyA p > code.language-text,.jNHeyA li > code.language-text{background:rgba(255,229,100,0.2);color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;} .jNHeyA table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;} .jNHeyA table th,.jNHeyA table td{padding:0.5em;background:#e8e8e8;border-bottom:2px solid white;} .jNHeyA:not(pre) a code[class*='language-']{color:#222222cc;background-color:rgba(255,229,100,0.2);}
/* sc-component-id: Article__ArticleWrapper-sc-1nyoqfc-0 */
.iTdcdb{padding:0 30px 30px;} @media only screen and (max-width:500px){.iTdcdb{padding:0;}}</style><title data-react-helmet="true">Service Mesh | 040code</title><link data-react-helmet="true" rel="canonical" href="https://040code.github.io/2019/07/01/cross-cluster-service-mesh"/><meta data-react-helmet="true" name="description" content="A multi cloud service mesh with Istio This post guide you to create a multi cloud service mesh with Istio on Kubernetes clusters in Amazon‚Ä¶"/><meta data-react-helmet="true" property="og:url" content="https://040code.github.io/2019/07/01/cross-cluster-service-mesh"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Service Mesh | 040code"/><meta data-react-helmet="true" property="og:description" content="A multi cloud service mesh with Istio This post guide you to create a multi cloud service mesh with Istio on Kubernetes clusters in Amazon‚Ä¶"/><meta data-react-helmet="true" property="og:image" content="https://040code.github.io/static/2019-07-01-cross-cluster-service-mesh-fb-9457b2e90ba4b667567bd462db03e5a5.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="niekos77"/><meta data-react-helmet="true" name="twitter:title" content="Service Mesh | 040code"/><meta data-react-helmet="true" name="twitter:description" content="A multi cloud service mesh with Istio This post guide you to create a multi cloud service mesh with Istio on Kubernetes clusters in Amazon‚Ä¶"/><meta data-react-helmet="true" name="twitter:image" content="https://040code.github.io/static/2019-07-01-cross-cluster-service-mesh-tw-13a2cd9ca2ffb15367c61bc0f96f0b9b.png"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=008654519ce705ac7bc44303a9014606"/><link as="script" rel="preload" href="/app-5643697e2de9bcce0385.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-658161403c49a8a1208a.js"/><link as="script" rel="preload" href="/commons-7e3c10fcd1b3528eff3a.js"/><link as="script" rel="preload" href="/webpack-runtime-13449825e32741877b57.js"/><link as="fetch" rel="preload" href="/page-data/2019/07/01/cross-cluster-service-mesh/page-data.json" crossorigin="anonymous"/></head><body><noscript>This site runs best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="SideMenu__StyledBurgerMenu-uekpe8-0 hTmxqc"><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/">üè° 040 blog</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/about">About</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/niek">Niek Palm</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/maarten">Maarten Metz</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/jeroen">Jeroen Knoops</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/stefan">Stefan van den Oord</a></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><span style="position:absolute;top:6px;right:14px"><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(45deg)"></span><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(-45deg)"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:0%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:40%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:80%;opacity:1"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></div><div style="margin:0 0"><div style="background-image:url(&quot;/static/evoluon-9f0ab370c0600504672aced739410981.jpg&quot;)" class="Hero__HeroContainer-sc-1i1rqpz-0 lfoWPa"><div class="Hero__TitleContainer-sc-1i1rqpz-1 hPmQYh"><h1 class="Hero__HeroTitle-sc-1i1rqpz-3 dANmgz">Service Mesh</h1><h2 class="Hero__HeroSubtitle-sc-1i1rqpz-4 brBAvj">A Multi Cloud Mesh with Istio</h2><span class="Hero__DateAndAuthor-sc-1i1rqpz-5 hpDnww">by:<!-- --> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/niek">niek</a>¬† on <!-- -->2019-07-01</span></div><div class="Hero__LocationContainer-sc-1i1rqpz-2 gEMFDS"><span class="Hero__LocationMarker-sc-1i1rqpz-8 eyJpws"><span class="fa fa-map-marker-alt"></span></span><a href="https://goo.gl/maps/WPrtxowKszHqgLNw9" target="_blank" class="Hero__LocationLink-sc-1i1rqpz-7 cmRrYK">Evoluon</a></div></div><main role="main" class="Wrapper-aej7i5-0 hwkicN"><article class="Article__ArticleWrapper-sc-1nyoqfc-0 iTdcdb"><section><header class="ContentHeader__Header-sc-1uw779c-0 jRHVYT"><div class="TagList__ListContainer-sc-1uj42o2-0 kQWgFX"><a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/kubernetes">kubernetes</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/service mesh">service mesh</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/cloud">cloud</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/aws">aws</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/google">google</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/docker">docker</a></div></header><div class="Content__ContentBody-sc-1jppj8x-0 jNHeyA"><h1 id="a-multi-cloud-service-mesh-with-istio"><a href="#a-multi-cloud-service-mesh-with-istio" aria-label="a multi cloud service mesh with istio permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A multi cloud service mesh with Istio</h1>
<p><em>This post guide you to create a multi cloud service mesh with Istio on Kubernetes clusters in Amazon and Google cloud.</em></p>
<p style="text-align: right">
  <a href="https://github.com/npalm/cross-cluster-mesh-postcard" target="sourcecode">
  <i class="fab fa-github" style="font-size: 200%">&nbsp;</i>Source code for this post</a></p>
<h2 id="introduction"><a href="#introduction" aria-label="introduction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h2>
<p>The last years we have seen a huge adoption of micro services architectures. Typically micro services brings a lot ff benefits such as flexibility, modularity, autonomy. But deploying and managing micro services architectures brings other difficulties. How dow you know what is running, how do you know your services are compliant? Another pattern that we see is that micro services ar typically heavy loaded with common dependencies for logging, authentication, authorization, tracing and many more cross cutting concerns.</p>
<p>A service mesh brings transparency to the chaos of micro services. A mesh can help with implementing, enforcing and managing requirements such as authentication, authorization, traceability and, data integrity. It also provides features as orchestration and collection of telemetry. There are currently several service meshes out, for example <a href="https://aws.amazon.com/app-mesh/">App Mesh</a> from Amazon, <a href="https://www.consul.io/">Consol</a> from HashiCorp, <a href="https://linkerd.io/">Linkerd</a> from the CNNF and <a href="https://istio.io/">Istio</a> launched by IBM, Lyft and Google in 2016. Istio is a fully open source solution based on the high performance proxy <a href="https://www.envoyproxy.io/">Envoy</a>.</p>
<p>Another trend in the industry is multi cloud or hybrid cloud. Confusing terms, no clear definitions. But it look likes common sense when we speaking about multi cloud we point to combining public clouds. And hybrid cloud is when you mix and match public with private cloud. When you start running cross cloud clusters it becomes even harder to manage all your micro services. Be confident that policies are implemented well or compliant. In this multi / hybrid topology, abstraction from cross cutting concerns to a mesh becomes even more important. In this blog we go to build a multi cloud <a href="https://kubernetes.io/">Kubernetes</a> cluster with an Istio service mesh.</p>
<h2 id="a-bit-more-about-a-service-mesh"><a href="#a-bit-more-about-a-service-mesh" aria-label="a bit more about a service mesh permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A bit more about a Service Mesh</h2>
<p>Before we dive into building a multi cloud service mesh, a few words about how a mesh works. An Istio mesh consists of two parts. A data plane, intelligent proxies (Envoy) deployed as sidecars. Those proxies mediate and control the network traffic. The second component is the control plane which manages and configures the proxies, and enforce policies.</p>
<p><img src="/fdc858d2c1e5605229e86884e3838713/istio-arch.svg" alt="istio-architecture"></p>
<p>To create a cross cluster mesh with Istio there are two topologies. In the first scenario there is a single control plain that controls all the cluster. In the second scenario a single control plain is deployed to every cluster and you have to ensure the same configuration is pushed to each cluster. In this post we will create an example based on the second option, a control plane in every cluster.</p>
<p><img src="/4463b084153941d1edea7583fe0befcf/multicluster-with-gateways.svg" alt="istio-multi-cluster"></p>
<h2 id="building-a-cross-cluster-mesh"><a href="#building-a-cross-cluster-mesh" aria-label="building a cross cluster mesh permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Building a cross cluster mesh</h2>
<p>Lets get started with building a multi cloud service mesh. A quite similar similar example as below is available on my <a href="https://github.com/npalm/cross-cluster-mesh-postcard">GitHub</a>. The example on GitHub is scripted with a set of simple shell scripts and created 3 clusters in 2 clouds. For this post we limited our selves to just 2 clusters in 2 clouds.</p>
<p>We will create 2 clusters and install in both clusters the Istio service mesh, one cluster on AWS (EKS) and the second on Google (GKE). For creating clusters you need to setup your environment with the right tools and credentials. For AWS the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">AWS CLI</a> is required, for Google you need the <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a>. Furthermore you need to install <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> to interact with Kubernetes. And <a href="https://helm.sh/">helm</a> as packagem manager for Kubernetes.</p>
<h3 id="setup-and-configure-eks-cluster"><a href="#setup-and-configure-eks-cluster" aria-label="setup and configure eks cluster permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setup and configure EKS cluster</h3>
<p>First we create EKS clusters with <code class="language-text">eksctl</code>. But cluster has a quite minimal configuration. See the page of <a href="https://eksctl.io/">weaveworks ekstcl</a> or <a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html">AWS</a> fom more details. Creating a cluster roughly takes 20 minutes. With the command below we create a default EKS cluster, with only one node it‚Äôs own VPC.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">export KUBECONFIG=kubeconfig-istio-1.config
export CLUSTER_NAME=mesh-1
eksctl create cluster \
  --name $CLUSTER_NAME \
  --region eu-central-1 \
  --version 1.13 \
  --node-type t3.medium \
  --nodes 2 \
  --nodes-min 2 \
  --nodes-max 4 
  --node-ami auto \
  --kubeconfig=$KUBECONFIG \
  --tags &quot;environment=multi-cloud-mesh&quot;

kubectl get nodes</code></pre></div>
<p>You should now have a Kubernetes cluster running on AWS. Next we download, install and configure Istio for our service mesh. In the steps below we use for simplicity the sample certificates provided by the Istio distribution. Should I really mention that you should replace those certificates for a real life setup‚Ä¶</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># Download Istio
export ISTIO_VERSION=1.1.9
curl -L https://git.io/getLatestIstio | sh -
export PATH=&quot;$PATH:$PWD/istio-1.1.9/bin&quot;

# Create namespace and install demo certificates 
kubectl apply -f istio-$ISTIO_VERSION/install/kubernetes/namespace.yaml
kubectl create secret generic -n istio-system cacerts \
  --from-file=istio-$ISTIO_VERSION/samples/certs/ca-cert.pem \
  --from-file=istio-$ISTIO_VERSION/samples/certs/ca-key.pem \
  --from-file=istio-$ISTIO_VERSION/samples/certs/root-cert.pem \
  --from-file=istio-$ISTIO_VERSION/samples/certs/cert-chain.pem

# Create a service account for helm.
kubectl create -f \
  istio-$ISTIO_VERSION/install/kubernetes/helm/helm-service-account.yaml
helm init --service-account tiller

# Install the Istio resources
helm install istio-$ISTIO_VERSION/install/kubernetes/helm/istio-init \
  --name istio-init --namespace istio-system</code></pre></div>
<p>The last step could take a minute or so, check with <code class="language-text">kubectl get crds | grep &#39;istio.io&#39; | wc -l</code> if the Istio custom resources are created. Once finished there should be 53 custom resources created. The last step for installing the service mesh is to create the Istio control plan.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">helm install --name istio --namespace istio-system \
  istio-$ISTIO_VERSION/install/kubernetes/helm/istio \
  --values istio-$ISTIO_VERSION/install/kubernetes/helm/istio/example-values/values-istio-multicluster-gateways.yaml </code></pre></div>
<p>For this example we simply enable sidecar injection for every pod in the default namespace. The sidecar will function as proxy and intercepts all network traffic to the containers in the pad.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl label namespace default istio-injection=enabled</code></pre></div>
<p>Services in a local Kubernetes share a common DNS suffix (e.g. <code class="language-text">svc.cluster.local</code>). To ba able to route our remote service we have to stub the Kubernetes DNS for the domain name <code class="language-text">.glabal</code>. Service in a remote cluster can then be addressed with the naming convention <code class="language-text">&lt;name&gt;.&lt;namespace&gt;.&lt;global&gt;</code>. Therefore we need to stub the Kubernetes DNS. EKS is using CoreDNS, so we add the config map below.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           upstream
           fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        proxy . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
    }
    global:53 {
        errors
        cache 30
        proxy . $(kubectl get svc -n istio-system istiocoredns -o jsonpath={.spec.clusterIP})
    }
EOF</code></pre></div>
<p>The service mesh on EKS is now ready to start serving applications.</p>
<h3 id="the-postcard-sample-application"><a href="#the-postcard-sample-application" aria-label="the postcard sample application permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Postcard sample application</h3>
<p>In this blog post we use a simple polyglot postcards application. It is always fun to write an application in yet another language. The postcard application consists of twe services. The first service is the <a href="https://github.com/npalm/cross-cluster-mesh-postcard/tree/master/greeter">greeter</a>, the greeter is written in NodeJS and generates a webpage with a postcard. The message on the postcard should be provided by the second application, the <a href="https://github.com/npalm/cross-cluster-mesh-postcard/tree/master/messenger">messenger</a>. THe messenger is a Rust application that will run on the second cluster. I returns a string message based on configuration.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 59.88620199146515%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABhElEQVQoz31SW27CQAzcF2qAVhBSQiCEQB4kbZH4QUIgzsUnPxyEo9Lx4tC0gVoa2Vrb48daCCFcoC+aooAWYAANyD8+zb4X1sZ6pJRDqHcOrJI6wCewBL6AlMkr8YEC+GA/xQ2tZzwe681mIx90KLIsU71ejypLY0zdRfGq3++r1WqlfiVNp1M9mUwoYAAkQATEZDuO093v9w+LkSRJIsMwtJVALpQC92Kx0OzvMhmNHwAedZimKRE6VBsYMajg6/F4FHEca570xhJFkeEOG7JcLlUQBIqLZUAILICcPuF8PtNaNMf+EI5GI1nbjSThkbTruurZyNQIVmZ4dfcu9LOEw+EgsUdK8HgNJf/sG50NxpWz2czmw/4hhHR4T3RTPdba931zvV4r/so34DsUtN+yLC0h9C1qPp8TYRtmmzvJ2Vae57VqhA3BuiStjO37rel/zkKfTidro+j9HWuwGuM2CYuiUNUv2zuqJed5ri6Xi7Xrne52O6u3261Yr9c2F9q+fQOLCCuHsrZCAAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/6854a1ea032315cd528b587ac93d763f/cc182/postcard-app.webp 148w,
/static/6854a1ea032315cd528b587ac93d763f/f7e40/postcard-app.webp 295w,
/static/6854a1ea032315cd528b587ac93d763f/1a2f4/postcard-app.webp 590w,
/static/6854a1ea032315cd528b587ac93d763f/5bf42/postcard-app.webp 703w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/6854a1ea032315cd528b587ac93d763f/cf440/postcard-app.png 148w,
/static/6854a1ea032315cd528b587ac93d763f/d2d38/postcard-app.png 295w,
/static/6854a1ea032315cd528b587ac93d763f/b9e4f/postcard-app.png 590w,
/static/6854a1ea032315cd528b587ac93d763f/afda5/postcard-app.png 703w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/6854a1ea032315cd528b587ac93d763f/b9e4f/postcard-app.png"
          alt="sequence"
          title="sequence"
          loading="lazy"
        />
      </picture>
    </span></p>
<p>The greeter app will print an error message in case the messenger is not available. We deploy now the greeter to the Kubernetes cluster on AWS. We create a standard deployment for the pod, a service, a Istio Gateway, and a Istio Virtual service. The Istio resources are created to make the postcard app public available via an ingress. You can check out the configuration files <a href="https://github.com/npalm/cross-cluster-mesh-postcard/tree/master/mesh/demo/greeter">here</a>. During deployment we update the configuration with name of the cluster.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># Deploy greeter pod and service
curl -L \
  https://raw.githubusercontent.com/npalm/cross-cluster-mesh-postcard/master/mesh/demo/greeter/greeter.yaml \
  | sed &quot;s/CLUSTER_NAME/${CLUSTER_NAME}/&quot; | kubectl apply -f -

# create gateway for greeter service
kubectl apply -f \
  https://raw.githubusercontent.com/npalm/cross-cluster-mesh-postcard/master/mesh/demo/greeter/gateway.yaml</code></pre></div>
<p>Once deployed we should already be able to see our postcard via a browser. You can construct the URL with the command below. It can taka few minutes before Load Balancer is ready to accept traffic.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">export ISTIO_INGRESS=$(kubectl -n istio-system \
  get service istio-ingressgateway \
  -o jsonpath=&#39;{.status.loadBalancer.ingress[0].hostname}&#39;)
open http://${ISTIO_INGRESS}/greeter</code></pre></div>
<p>The postcard shows no message from the second cluster. But our greeter app is up and running. The next steps is creating the second cluster.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 67.25543478260869%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABn0lEQVQoz4VSS0vDQBjMr+4PEAS9C73pRTyoBw+Cl3hQRNCL0pOitEl2m2Q370eTbJ7ONjFWW3AIYV/zzXyzq7Tf6Lqu/1NKwzD0PY9znuVZURSEGEEQYP/05nbvaP/kcnqu3uGk0m3BdV3f923LCgK/qqqmadI0Xa1W2LpW1cnB5PPtIg4JhJQoigghSZqOykCWZVEU4g9ZLIJZCoH1++eH6dnhlXpc5Ewqw6FhGI7rRGvEcQyHEOxLpL+L5iInbKmbpCgySYZDNMk4M4iBgWma8/kcNOxBFrUsy9I0TYiiruuqrJq6wYfqqLij5xEgMGajHCVEWyx0XXccJ0kSVER1SR7TRjDtBnplhJfneZpIyNjWyQHg4/xu5Z4shICUJK+BQZatklgqYzrYbrt2jGSTDG/9Df0xNVr7p2eobaY9lO6GqRLHEfrBS4LJsiyRKHRAQ6bbtNEXjg3KmIDmBwHnzLZt10Wnjue6eAK4edxlKDFc/nBeyMejzF4eZ69P3KT6xzunxDZ0Rg3HXHqWxZfU4wzZoHW0D0c/0q1M4QvHg+eDTp+GfwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/65a524c772eee3938ab0a86e19810340/cc182/postcard-1.webp 148w,
/static/65a524c772eee3938ab0a86e19810340/f7e40/postcard-1.webp 295w,
/static/65a524c772eee3938ab0a86e19810340/1a2f4/postcard-1.webp 590w,
/static/65a524c772eee3938ab0a86e19810340/4837b/postcard-1.webp 885w,
/static/65a524c772eee3938ab0a86e19810340/2f819/postcard-1.webp 1180w,
/static/65a524c772eee3938ab0a86e19810340/e71d5/postcard-1.webp 1472w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/65a524c772eee3938ab0a86e19810340/cf440/postcard-1.png 148w,
/static/65a524c772eee3938ab0a86e19810340/d2d38/postcard-1.png 295w,
/static/65a524c772eee3938ab0a86e19810340/b9e4f/postcard-1.png 590w,
/static/65a524c772eee3938ab0a86e19810340/f9b6a/postcard-1.png 885w,
/static/65a524c772eee3938ab0a86e19810340/2d849/postcard-1.png 1180w,
/static/65a524c772eee3938ab0a86e19810340/cef07/postcard-1.png 1472w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/65a524c772eee3938ab0a86e19810340/b9e4f/postcard-1.png"
          alt="postcard"
          title="postcard"
          loading="lazy"
        />
      </picture>
    </span></p>
<h3 id="setup-and-configure-gke-cluster"><a href="#setup-and-configure-gke-cluster" aria-label="setup and configure gke cluster permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setup and configure GKE cluster</h3>
<p>For the second cluster we create a GKE cluster on Google Cloud. You can replace by a second cluster in Amazon or one in another cloud. The first step is similar to creating a cluster in AWS but now one in Google. Open a new terminal to avoid conflicting environment variables.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">export KUBECONFIG=kubeconfig-istio-2.config
export CLUSTER_NAME=mesh-2
gcloud container clusters create \
    --machine-type n1-standard-4 \
    --num-nodes 1 --enable-autoscaling \
    --min-nodes 1 --max-nodes 5 \
    --addons HttpLoadBalancing,HorizontalPodAutoscaling,KubernetesDashboard \
    --cluster-version 1.13 --zone europe-west3-b \
    $CLUSTER_NAME

kubectl create clusterrolebinding mt-admin --user &quot;$(gcloud config get-value core/account)&quot; --clusterrole cluster-admin

kubectl get nodes</code></pre></div>
<p>The cluster will created in roughly 5 minutes. Next you have to install Istio. The steps are exactly the same as above. Only the last step where we configure the DNS is different since GKE use kube-dns instead of core-dns. Execute the command below to stub  the DNS.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-dns
  namespace: kube-system
data:
  stubDomains: |
    {&quot;global&quot;: [&quot;$(kubectl get svc -n istio-system istiocoredns -o jsonpath={.spec.clusterIP})&quot;]}
EOF</code></pre></div>
<h3 id="the-postcard-sample-application---part-ii"><a href="#the-postcard-sample-application---part-ii" aria-label="the postcard sample application   part ii permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Postcard sample application - part II</h3>
<p>On the second cluster we deploy the messenger app that simply sends a message back. The message can be configures via an environment variable. Install the messenger the app with the <code class="language-text">kubectl</code> command below.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># Deploy greeter pod and service
curl -L \
  https://raw.githubusercontent.com/npalm/cross-cluster-mesh-postcard/master/mesh/demo/messenger/messenger.yaml \
  | sed &quot;s/MESSAGE_TEXT/All good from Google Cloude/&quot; \
  | kubectl apply -f -</code></pre></div>
<p>Only one step left now. We need to configure the first cluster with a service entry so the mesh knows how to route calls for <code class="language-text">messanger.default.global</code>. We switch back to the terminal where we have created the first cluster on Amazon. And lookup using the kubeconfig from the second cluster the ip address of the ingress loadbalancer. Next we create a service entry.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># Lookup the ingress ip address
export CLUSTER_GW_ADDR=$(kubectl \
  --kubeconfig=kubeconfig-istio-2.config \
  get svc --selector=app=istio-ingressgateway -n istio-system \
  -o jsonpath=&#39;{.items[0].status.loadBalancer.ingress[0].ip}&#39;)
echo $CLUSTER_GW_ADDR

# Create a service entry
kubectl apply -f - &lt;&lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: messenger
spec:
  hosts:
  - messenger.default.global
  location: MESH_INTERNAL
  ports:
  - name: http1
    number: 3000
    protocol: http
  resolution: DNS
  addresses:
  - 127.127.42.69
  endpoints:
  - address: $CLUSTER_GW_ADDR
    ports:
      http1: 15443 # Do not change this port value
EOF</code></pre></div>
<p>Now our postcard application should get the message from the second cluster, go back to the browser and refresh the page. You should now see card as below.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 67.53782668500688%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAABu0lEQVQoz21SPU/DMBTMz2ZmgA0hGCgSEkiVYEDsbExIjAiEKlAr2qSxHef724kbl3PSpqFwg2U/v3vvfH6GUmrdottUVVUUhRCiKIu6rhHJsqwsS9U0qlmFSZKkKeV+lue4MtQAODPKgiB0Xdf3PKyIUEIch6VpWtfi4OxyfH9+Mh49v35o8nqLjhyGYRzHWAPfz9IMEQjJ81wLEeJ4dHF6dcisxzDimsw5RyrWIAhA831/uVxOJhPTXODYk1FalNX1w83o9ujp5U41GXoZpmki27IsbCili8ViNpuhhG0THHtFHYhrv329f31/SlnpzkgFjRAyn8+n0ykKMcZwIaVEQxiEoOM4KAH/mqbR5Rq1Wq0GhukGanPXtkJq9wrUcjnXzy4KOA8jAFGJjWE9bb0TqDtHUQQ7PM8DHw4mCarFyRZg7dzesx3C0BbZMBJ2QjkbACo2stf/QdYS5Tu3UaJoZUM8NCOOKfr1z/tkKTEYe27vwZBbQCdejtR+043nX24/jgZkQAyaaBPSpLUUp7QrAfSbnowYRrV9M7yRdeB7xLYxxoxSj3P8DSOEEgqfKCWuy+H7sLOUWtQPYQYelli44ncAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/75c36dfd28c1fd9ca137ef41c1ed2210/cc182/postcard-2.webp 148w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/f7e40/postcard-2.webp 295w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/1a2f4/postcard-2.webp 590w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/4837b/postcard-2.webp 885w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/2f819/postcard-2.webp 1180w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/9c8b8/postcard-2.webp 1454w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/75c36dfd28c1fd9ca137ef41c1ed2210/cf440/postcard-2.png 148w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/d2d38/postcard-2.png 295w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/b9e4f/postcard-2.png 590w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/f9b6a/postcard-2.png 885w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/2d849/postcard-2.png 1180w,
/static/75c36dfd28c1fd9ca137ef41c1ed2210/7aa09/postcard-2.png 1454w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/75c36dfd28c1fd9ca137ef41c1ed2210/b9e4f/postcard-2.png"
          alt="postcard"
          title="postcard"
          loading="lazy"
        />
      </picture>
    </span></p>
<p>That is all you need to do for creating a cross cluster service mesh.</p>
<h2 id="cleanup"><a href="#cleanup" aria-label="cleanup permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cleanup</h2>
<p>The cleanup steps below assume you created fresh cluster and don‚Äôt use them for hosting other applications. The Amazon cluster was created via <code class="language-text">eksctl</code>. This tool actually create cloud formation stacks in Amazon. Before you delete the stack, you need to delete the load balancer created by Istio. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># Find the load balancer
aws elb describe-load-balancers | jq -r &quot;.LoadBalancerDescriptions[].LoadBalancerName&quot;

# delete the load balancer  
aws elb delete-load-balancer --load-balancer-name &lt;lb-name&gt;</code></pre></div>
<p>Now you can delete the cluster, the deletion is a asynchronous process. Ensure you verify the deletion went well. In case it fails, happens many times to me. Delete the VPC and retry the delete via cloud formation.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">delete cluster --name mesh-1 --region=eu-central-1</code></pre></div>
<p>For Google Cloud the deletion is very easy. Deletion of the cluster will delete all dependent resources.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">cloud container clusters delete --zone europe-west3-b $CLUSTER_NAME</code></pre></div>
<h2 id="acknowledgements"><a href="#acknowledgements" aria-label="acknowledgements permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Acknowledgements</h2>
<p>The example used in the blog is inspired by a great talk from Matt Turner at the KubeCon - CloudNativeCon 2019 in Barcelona. His talk and example is available in the blog post <a href="https://mt165.co.uk/speech/cross-cluster-calls-istio-1-1-kubecon-eu-19/">Cross-cluster Calls Made Easy with Istio 1.1</a>.</p></div></section></article></main><main role="main" class="Wrapper-aej7i5-0 hwkicN"><div id="disqus_thread"></div><p class="Commons__Text-sc-1yiug1-1 dDhPjG">Read next:</p><ul><li><a class="Commons__StyledLink-sc-1yiug1-0 iinOhl" href="/2019/04/18/cloudrun">Cloud Run</a></li><li><a class="Commons__StyledLink-sc-1yiug1-0 iinOhl" href="/2019/09/02/automating-the-manual-aws-amplify-deploy">Micro Hack - AWS Amplify</a></li></ul></main></div><footer class="Footer__FooterWrapper-sc-1oxe0wr-0 hFicPH"><nav><div class="footer-col"><h5 class="footer-title">040 code ¬© 2019</h5><span class="footer-item">Build with <i></i><a class="footer-link" href="https://www.gatsbyjs.org/">Gatsby</a></span></div><div class="footer-col"><h5 class="footer-title">Blog</h5><span class="footer-item"><a class="footer-link" href="/">home</a></span><span class="footer-item"><a class="footer-link" href="/about">about</a></span></div><div class="footer-col"><h5 class="footer-title">Source</h5><span class="footer-item"><i></i><a class="footer-link" href="https://github.com/040code/">Github</a></span></div></nav></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97020149-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2019/07/01/cross-cluster-service-mesh";window.webpackCompilationHash="5922713c92655645bc49";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-5643697e2de9bcce0385.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-c4fe219a301439484a06.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-3478508ec23c2934e4f1.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-658161403c49a8a1208a.js"],"component---src-templates-page-js":["/component---src-templates-page-js-7e7e89f412e118251bb2.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-5a23d2283ad3d5c31166.js"],"component---src-templates-authors-js":["/component---src-templates-authors-js-c6344b2044878ea20b55.js"],"component---src-pages-404-js":["/component---src-pages-404-js-97ff63f7f4b2c8c3c88f.js"]};/*]]>*/</script><script src="/webpack-runtime-13449825e32741877b57.js" async=""></script><script src="/commons-7e3c10fcd1b3528eff3a.js" async=""></script><script src="/component---src-templates-blog-post-js-658161403c49a8a1208a.js" async=""></script><script src="/app-5643697e2de9bcce0385.js" async=""></script></body></html>