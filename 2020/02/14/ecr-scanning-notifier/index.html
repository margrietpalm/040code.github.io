<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/><style data-href="/commons.131b48b25a50eff60b34.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.15.19"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="hTmxqc lcZENV lfoWPa hPmQYh dANmgz brBAvj hpDnww bWPqAN gEMFDS eyJpws cmRrYK hwkicN iTdcdb jRHVYT kQWgFX itRnbT jNHeyA hFicPH" data-styled-version="4.3.2">
/* sc-component-id: SideMenu__StyledBurgerMenu-uekpe8-0 */
.hTmxqc .bm-burger-button{position:fixed;width:36px;height:30px;left:36px;top:36px;} .hTmxqc .bm-burger-bars{background:#ffffff;} .hTmxqc .bm-cross-button{height:24px;width:24px;} .hTmxqc .bm-cross{background:#ffffff;} .hTmxqc .bm-menu{background:rgb(0,0,0,0.5);padding:2.5em 1em 0;font-size:1.15em;} .hTmxqc .bm-morph-shape{fill:#373a47;} .hTmxqc .bm-item-list{padding-top:2em;} .hTmxqc .bm-item{display:inline-block;padding:0.5em;} .hTmxqc .bm-overlay{background:rgba(0,0,0,0.3);}
/* sc-component-id: SideMenu__MenuLink-uekpe8-1 */
.lcZENV{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;border:0;margin:0;margin-right:0.5rem;padding-left:20px;padding-right:20px;min-width:42px;z-index:10;}
/* sc-component-id: Footer__FooterWrapper-sc-1oxe0wr-0 */
.hFicPH{text-align:left;padding-top:30px;padding-bottom:50px;background-color:rgba(32,35,42,0.85);color:#ffffff;padding-left:20px;padding-right:20px;margin:3.5em auto 0 0;} .hFicPH nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;} .hFicPH nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-bottom:1em;padding-right:1em;} .hFicPH a{color:#ffffff;font-weight:bold;} .hFicPH a:hover{color:#e8e8e8;border-bottom:1px dotted #e8e8e8;} .hFicPH .footer-col > p{margin:0;} .hFicPH .footer-title{margin:0 0 1rem;} .hFicPH .footer-item{padding:0.25rem 0;color:#ffffff;} .hFicPH .footer-heart{color:red;} .hFicPH .footer-item-text{padding:0.1rem 0;color:#ffffff;} .hFicPH .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;} @media (max-width:564px){.hFicPH .footer-col:first-child{width:100%;}}
/* sc-component-id: sc-global-3886539976 */
*{box-sizing:border-box;margin:0;padding:0;} body{font-family:"Lato",sans-serif;color:#222222cc;background-color:#e8e8e8;} img{max-width:100%;height:auto;vertical-align:middle;border:0;} a{-webkit-text-decoration:none;text-decoration:none;color:rgba(34,34,34,0.8);} ul,ol{padding-left:2em;margin:1em 0 0 0;}
/* sc-component-id: Wrapper-aej7i5-0 */
.hwkicN{position:relative;border-radius:3px;width:80%;max-width:770px;border-bottom:1px solid #ebf2f6;word-wrap:break-word;background-color:#fff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);} @media (max-width:780px){.hwkicN{width:90%;padding:25px;}}
/* sc-component-id: Hero__HeroContainer-sc-1i1rqpz-0 */
.lfoWPa{position:relative;display:table;width:100%;height:340px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}
/* sc-component-id: Hero__TitleContainer-sc-1i1rqpz-1 */
.hPmQYh{display:table-cell;vertical-align:middle;text-align:center;width:100%;}
/* sc-component-id: Hero__LocationContainer-sc-1i1rqpz-2 */
.gEMFDS{display:table-footer-group;vertical-align:center;text-align:right;width:100%;}
/* sc-component-id: Hero__HeroTitle-sc-1i1rqpz-3 */
.dANmgz{font-size:3.5rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-weight:800;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__HeroSubtitle-sc-1i1rqpz-4 */
.brBAvj{font-size:1.7rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__DateAndAuthor-sc-1i1rqpz-5 */
.hpDnww{font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;}
/* sc-component-id: Hero__AuthorLink-sc-1i1rqpz-6 */
.bWPqAN{margin-left:0.3rem;font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;} .bWPqAN:hover{border-bottom:1px dotted #787676;} .bWPqAN:before{content:'@';}
/* sc-component-id: Hero__LocationLink-sc-1i1rqpz-7 */
.cmRrYK{margin-right:0.7rem;font-size:0.9rem;color:#fff;text-shadow:2px 2px #222222;font-size:1rem;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;font-style:italic;} .cmRrYK:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: Hero__LocationMarker-sc-1i1rqpz-8 */
.eyJpws{margin-right:0.4rem;font-size:0.75rem;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: TagList__ListContainer-sc-1uj42o2-0 */
.kQWgFX{display:inline;margin:0 0.5rem 0 0;color:#787676;}
/* sc-component-id: TagList__TagListItem-sc-1uj42o2-1 */
.itRnbT{margin-left:0.3rem;display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#777;border-radius:10px;} .itRnbT:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: ContentHeader__Header-sc-1uw779c-0 */
.jRHVYT{margin-bottom:2rem;color:#787676;}
/* sc-component-id: Content__ContentBody-sc-1jppj8x-0 */
.jNHeyA{line-height:1.6;} .jNHeyA > *:first-child{padding-top:0;margin-top:0;} .jNHeyA > h1{margin-top:3rem;font-size:2em;} .jNHeyA > h2{margin-top:3rem;font-size:1.5em;} .jNHeyA > h3{padding-top:3rem;font-size:1.17em;} .jNHeyA > p{margin:1em 0 0 0;} .jNHeyA a{border-bottom:1px dotted rgba(162,162,162,0.8);} .jNHeyA a:hover{border-bottom-style:solid;} .jNHeyA a.anchor,.jNHeyA a.gatsby-resp-image-link{border:none;} .jNHeyA > blockquote{box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:0.4em solid rgba(32,35,42,0.85);} .jNHeyA > blockquote p{margin:0.8em 0;font-style:italic;} .jNHeyA .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;background:#2d2d2d;color:#ffffff;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em 0em 1.5em 0;font-size:0.7em;} .jNHeyA .gatsby-highlight > pre{border:0;margin:0;padding:1;} .jNHeyA .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffa7c4;} .jNHeyA p > code.language-text,.jNHeyA li > code.language-text{background:rgba(255,229,100,0.2);color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;} .jNHeyA table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;} .jNHeyA table th,.jNHeyA table td{padding:0.5em;background:#e8e8e8;border-bottom:2px solid white;} .jNHeyA:not(pre) a code[class*='language-']{color:#222222cc;background-color:rgba(255,229,100,0.2);}
/* sc-component-id: Article__ArticleWrapper-sc-1nyoqfc-0 */
.iTdcdb{padding:0 30px 30px;} @media only screen and (max-width:500px){.iTdcdb{padding:0;}}</style><title data-react-helmet="true">AWS ECR Vulnerabilities Notifier | 040code</title><link data-react-helmet="true" rel="stylesheet" type="text/css" href="/asciinema-player.css"/><link data-react-helmet="true" rel="canonical" href="https://040code.github.io/2020/02/14/ecr-scanning-notifier"/><meta data-react-helmet="true" name="description" content="This post explains how to scan docker images on AWS ECR and get notified when a new vulnerability is found. Introduction On October 201‚Ä¶"/><meta data-react-helmet="true" property="og:url" content="https://040code.github.io/2020/02/14/ecr-scanning-notifier"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="AWS ECR Vulnerabilities Notifier | 040code"/><meta data-react-helmet="true" property="og:description" content="This post explains how to scan docker images on AWS ECR and get notified when a new vulnerability is found. Introduction On October 201‚Ä¶"/><meta data-react-helmet="true" property="og:image" content="https://040code.github.io/static/2020-02-14-ecr-scanning-notifier-fb-0963834a4a69cd20d940c78cb340f7dc.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="niekos77"/><meta data-react-helmet="true" name="twitter:title" content="AWS ECR Vulnerabilities Notifier | 040code"/><meta data-react-helmet="true" name="twitter:description" content="This post explains how to scan docker images on AWS ECR and get notified when a new vulnerability is found. Introduction On October 201‚Ä¶"/><meta data-react-helmet="true" name="twitter:image" content="https://040code.github.io/static/2020-02-14-ecr-scanning-notifier-tw-62ec0bf293dfaa0612b4a0c2df572dae.png"/><script data-react-helmet="true" src="/asciinema-player.js"></script><link rel="shortcut icon" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=008654519ce705ac7bc44303a9014606"/><link as="script" rel="preload" href="/app-5643697e2de9bcce0385.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-658161403c49a8a1208a.js"/><link as="script" rel="preload" href="/commons-34dc266fc00251e3bca6.js"/><link as="script" rel="preload" href="/webpack-runtime-13449825e32741877b57.js"/><link as="fetch" rel="preload" href="/page-data/2020/02/14/ecr-scanning-notifier/page-data.json" crossorigin="anonymous"/></head><body><noscript>This site runs best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="SideMenu__StyledBurgerMenu-uekpe8-0 hTmxqc"><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/">üè° 040 blog</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/about">About</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/niek">Niek Palm</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/maarten">Maarten Metz</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/jeroen">Jeroen Knoops</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/stefan">Stefan van den Oord</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/thales">Thales Sousa</a></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><span style="position:absolute;top:6px;right:14px"><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(45deg)"></span><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(-45deg)"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:0%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:40%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:80%;opacity:1"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></div><div style="margin:0 0"><div style="background-image:url(&quot;/static/cover-98e3ee35420010f375fb3fdfb06a1e4b.jpg&quot;)" class="Hero__HeroContainer-sc-1i1rqpz-0 lfoWPa"><div class="Hero__TitleContainer-sc-1i1rqpz-1 hPmQYh"><h1 class="Hero__HeroTitle-sc-1i1rqpz-3 dANmgz">AWS ECR Vulnerabilities Notifier</h1><h2 class="Hero__HeroSubtitle-sc-1i1rqpz-4 brBAvj">We only want to be bothered once a new vulnerability is found</h2><span class="Hero__DateAndAuthor-sc-1i1rqpz-5 hpDnww">by:<!-- --> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/thales">thales</a> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/niek">niek</a>¬† on <!-- -->2020-02-14</span></div><div class="Hero__LocationContainer-sc-1i1rqpz-2 gEMFDS"><span class="Hero__LocationMarker-sc-1i1rqpz-8 eyJpws"><span class="fa fa-map-marker-alt"></span></span><a href="https://goo.gl/maps/Pmo2wUq862Fd7Kop9" target="_blank" class="Hero__LocationLink-sc-1i1rqpz-7 cmRrYK">Diving in the sea of colors - Glow 2019</a></div></div><main role="main" class="Wrapper-aej7i5-0 hwkicN"><article class="Article__ArticleWrapper-sc-1nyoqfc-0 iTdcdb"><section><header class="ContentHeader__Header-sc-1uw779c-0 jRHVYT"><div class="TagList__ListContainer-sc-1uj42o2-0 kQWgFX"><a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/docker">docker</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/vulnerabilities">vulnerabilities</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/serverless">serverless</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/aws">aws</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/terraform">terraform</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/lambda">lambda</a></div></header><div class="Content__ContentBody-sc-1jppj8x-0 jNHeyA"><p><em>This post explains how to scan docker images on AWS ECR and get notified when a new vulnerability is found.</em></p>
<p style="text-align: right">
  <a href="https://github.com/philips-labs/aws-ecr-scanning-slack-notifications" target="sourcecode">
  <i class="fab fa-github" style="font-size: 200%">&nbsp;</i>Source code for this post</a></p>
<h2 id="introduction"><a href="#introduction" aria-label="introduction permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h2>
<p>On October 2019, AWS released a nice <a href="https://aws.amazon.com/about-aws/whats-new/2019/10/announcing-image-scanning-for-amazon-ecr/">feature</a> on AWS ECR (Elastic Container Registry). They introduced the ability to scan docker images hosted within ECR in order to detect vulnerabilities.</p>
<p>ECR scanning is free of charge, but you can only scan the same image every 24 hours. You get throttled if you make more than 1 request within 1 day. Naturally, scans are only triggered when an image is pushed. This blog explains how to trigger the scans at your own pace (for example, on a daily basis).</p>
<p>Since we love automation, we have decided to automate scanning task using a full serverless application that sends via slack a notification when there is a change in the scanning results.</p>
<h2 id="why"><a href="#why" aria-label="why permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why?</h2>
<p>Docker images are pulled left and right. You find yourself constantly looking for that new image which solves the majority of your problems. You find it. You pull it. You execute it. You like it. You decide to push it to your own ECR Registry because you‚Äôre afraid the original publisher eventually deletes it from DockerHub, or you simply need a private docker registry. But did you really check what was inside it? Are you aware of all the libraries and packages this image is using? What if there are critical security issues with that image that may compromise the software you‚Äôre running? What if your company loses tens of thousands (or maybe millions) of dollars just because a vulnerability that was never known?</p>
<p>It may sound scary, and it actually is! Vulnerabilities are everywhere and there‚Äôs very little you can do to mitigate the problem on your own. Usually, responsible publishers fix these vulnerabilities as soon as they are detected. However, not using a compromised image already is a step in the right direction. Automating this process is even nicer because you can react on it and decide what path to take: whether tailoring your own Docker images or just temporarily suspending the use for a compromised one.</p>
<h2 id="how"><a href="#how" aria-label="how permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How?</h2>
<p>There are mainly two ways which you can scan your Docker images for vulnerabilities:</p>
<ol>
<li>Enabling <em>Scan on push</em> for a given ECR registry, which will scan every image and output the results within the ECR console.</li>
<li>Using the AWS SDK to invoke the APIs in an automated way.</li>
</ol>
<p>We like #2 because the more automated a process is the better. For example using Terraform:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_ecr_repository&quot; &quot;my_repo&quot; {
  name                 = &quot;my-image&quot;

  image_scanning_configuration {
    scan_on_push = true
  }
}</code></pre></div>
<h2 id="notifying-changes"><a href="#notifying-changes" aria-label="notifying changes permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Notifying Changes</h2>
<p>You don‚Äôt want to be notified every single time a image was scanned, do you? You only want to be notified when there were vulnerabilities detected for a new image or if the vulnerabilities for a previously scanned image have changed. This means that this state must be stored somewhere. DynamoDB is a great choice here because we can easily store such state there and we can also react to any Table changes using DynamoDB Streams. Do you smell an Event Driven Architecture already?</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 89.32203389830508%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAADbklEQVQ4y2NgQAJ8DKwgiimF1xDM2C0cZrBZKEgHxA7hUGNiIBXwMbJzACnW6ew2/McEw40OCYVbrufzUQZZws/Ezg2kGUkykJeBhRNEVyv6SS4RDwpeKRYU2CftrwISE2JgYWdkYmIm1ZHsooraLGp6dmIqQKyqZyeopmsrqmjhDgoCNiZmVsLe/tpqAmczMjJy4FIHlGMHeZ2wgb1OYPr/uxgGVxN1rlWJukxCmj4M5roOjA56jgysYgZgeX9jBa48e1kWENteQ4Lha4sJbkMPxEuhBPb//+/g7Jm+Ygyocv/hbNMjb6H0C0aDXYsgrv/aZgo27GeTjuKbycFrPjUZBID476rUGT+2WUIMmaHO9qDDo+hprZEtiH+lRJ/xfw84NTHonXkJt6Dz/DpGhm8T3VkgBps1/b895//3WeFXIS55zfi31xoiV6sW//9M1/8fs0If/YeG461aEwa1C79hzhZlObpbF8y+0uwJduGpKgfDxx3uh+51+aaA+NNzfJh2ZRmCNd+oNjd7NS3y+fNp0XNBfG2HAOb/nzcxZC3aC9ab2ne0MnNNxZaewyIiYEO5OVhFwUmNgUECxGViYZEC0iDXMXGxMYPYfMDUrQWkpYFYmJ0JrJbhEdSrN80yo583u3Ye+1kpghLgoXa67MiBjgosmY0yJ8Ijb9PmTWD24SNHNA6dOl6wedvO8mMnzgYw+OdZgBUkzXFiUjYU4/XI1WMRNeQBixk5+IPpDa//Mxjoe/DYOJWwIVsRlBAEDcJLDI4a/Ig0nD7RD8M9vpMVwLRj2HKM/Ctr0o5IRqfLUSWL1viDNWSscLJPmOFQlrDAOiJioS7YtqjWLWC5oNLvpiEFt0uCip4nuhf950FPk6/6fOTvV+jZgDmlC1PAGT5rid/aqt3R/wtXhr127lYQB8tNWwtONslVzyZ3zvv/P7H82R8dt+OgyGHQVbcBZsUopmJghH2ZHXXt/+bi/5+KJVwZ/v0PBxvs0WW0JmC2+f+AfptXOrX8oFhnKJm4HmxZZOKlSY2dH/8HRZ//LaW6DmygopQ+0BeyzB4MDDzvpoWd+Lmy4P/bFnNbBhVDW1FpaQd+rQQ1V+cy21TtNKVgGRstcRVtZ2E1Ey92cOSYT7Fxcl+aamq1IFrDoEYMLUi5QtVY9Vus2RyAbBEASBsNZT8oZQsAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/5bd68d9642c5bed3145f07ca22a98bc0/cc182/aws-ecr-notification-architecture.webp 148w,
/static/5bd68d9642c5bed3145f07ca22a98bc0/f7e40/aws-ecr-notification-architecture.webp 295w,
/static/5bd68d9642c5bed3145f07ca22a98bc0/1a2f4/aws-ecr-notification-architecture.webp 590w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/5bd68d9642c5bed3145f07ca22a98bc0/cf440/aws-ecr-notification-architecture.png 148w,
/static/5bd68d9642c5bed3145f07ca22a98bc0/d2d38/aws-ecr-notification-architecture.png 295w,
/static/5bd68d9642c5bed3145f07ca22a98bc0/b9e4f/aws-ecr-notification-architecture.png 590w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/5bd68d9642c5bed3145f07ca22a98bc0/b9e4f/aws-ecr-notification-architecture.png"
          alt="architecture"
          title="Slack Message"
          loading="lazy"
        />
      </picture>
    </span></p>
<h2 id="getting-our-hands-dirty"><a href="#getting-our-hands-dirty" aria-label="getting our hands dirty permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting our hands dirty</h2>
<h3 id="scanning-images"><a href="#scanning-images" aria-label="scanning images permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scanning images</h3>
<p>For our use case, we decided to put all the ECR repositories to be scanned in a <code class="language-text">.json</code> file within an S3 bucket. Everytime the Lambda function runs, it downloads that file, parses it and issues <code class="language-text">listImages</code> for every repository defined and <code class="language-text">startImageScan</code> for every image found.</p>
<p>Using the Node.js SDK and AWS SDK, we can easily put it together, see <a href="https://github.com/philips-labs/aws-ecr-scanning-slack-notifications">github</a> for the full code.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">scan</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> s3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">S3</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    Bucket<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BUCKET</span><span class="token punctuation">,</span>
    Key<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">KEY</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> repositories <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>s3<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> repository <span class="token keyword">of</span> repositories<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> images <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">ECR</span><span class="token punctuation">.</span><span class="token function">listImages</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      registryId<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REGISTRY_ID</span><span class="token punctuation">,</span>
      repositoryName<span class="token punctuation">:</span> repository
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> imageId <span class="token keyword">of</span> images<span class="token punctuation">.</span>imageIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> <span class="token constant">ECR</span><span class="token punctuation">.</span><span class="token function">startImageScan</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          registryId<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REGISTRY_ID</span><span class="token punctuation">,</span>
          repositoryName<span class="token punctuation">:</span> repository<span class="token punctuation">,</span>
          imageId
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed scanning image: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>repository<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>imageId<span class="token punctuation">.</span>imageTag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>This task is as easy as that. It invokes the SDK to start an image scan. This process will now be run asynchronously in AWS.</p>
<h3 id="analysing-the-results-for-a-scanned-image"><a href="#analysing-the-results-for-a-scanned-image" aria-label="analysing the results for a scanned image permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Analysing the results for a Scanned image</h3>
<p>This could be achieved by reacting to CloudWatch events in AWS, but we decided to go the easy way and periodically poll ECR for the Scan Findings. If something was found, we store the findings in DynamoDB.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">analyse</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> repository <span class="token keyword">of</span> repositories<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> images <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">ECR</span><span class="token punctuation">.</span><span class="token function">listImages</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      registryId<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REGISTRY_ID</span><span class="token punctuation">,</span>
      repositoryName<span class="token punctuation">:</span> repository
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> imageId <span class="token keyword">of</span> images<span class="token punctuation">.</span>imageIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">ECR</span><span class="token punctuation">.</span><span class="token function">describeImageScanFindings</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        registryId<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REGISTRY_ID</span><span class="token punctuation">,</span>
        repositoryName<span class="token punctuation">:</span> repository<span class="token punctuation">,</span>
        imageId
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dynamoDbPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
          DynamoDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            TableName<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DOCKER_IMAGES_VULNERABILITIES_TABLE</span><span class="token punctuation">,</span>
            Item<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              sha_digest<span class="token punctuation">:</span> imageId<span class="token punctuation">.</span>imageDigest<span class="token punctuation">,</span>
              tag<span class="token punctuation">:</span> imageId<span class="token punctuation">.</span>imageTag<span class="token punctuation">,</span>
              aws_vulnerabilities<span class="token punctuation">:</span> results<span class="token punctuation">.</span>imageScanFindings<span class="token punctuation">.</span>findingSeverityCounts<span class="token punctuation">,</span>
              repository<span class="token punctuation">:</span> repository<span class="token punctuation">,</span>
              registry_id<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REGISTRY_ID</span><span class="token punctuation">,</span>
              last_run<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>dynamoDbPromises<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>The code snippet above always inserts data into DynamoDB, because we don‚Äôt want to check during analysis time whether something has changed or not. This would require a new query to DynamoDB and extra logic to this function. We want to keep the functions small and concise, so we will create another function very soon to check whether there have been changes in a given image or not.</p>
<h3 id="notifying-should-there-be-vulnerability-changes"><a href="#notifying-should-there-be-vulnerability-changes" aria-label="notifying should there be vulnerability changes permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Notifying should there be vulnerability changes</h3>
<p>Should there be any vulnerability changes to a previously scanned image or any vulnerabilities at all for a new image, we want to be aware of that.</p>
<p>Since we are already using DynamoDB, we can use DynamoDB Streams to react on write events. If you remember correctly, our previous function <em>always</em> pushes data to DynamoDB, meaning a Stream will always be triggered. Let‚Äôs use that in our favor and have a Lambda function react upon it. This new function will be smart enough to check whether something changed or if a new image was scanned. In any case, it will trigger a notification to a Slack channel. If there are no changes at all, the Lambda function then does nothing but happily terminate.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> converter <span class="token operator">=</span> <span class="token constant">AWS</span><span class="token punctuation">.</span>DynamoDB<span class="token punctuation">.</span>Converter<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">notify</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">records</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>eventName <span class="token operator">===</span> <span class="token string">"INSERT"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// code omitted, see github</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>eventName <span class="token operator">===</span> <span class="token string">"MODIFY"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> potentiallyChangedRecord <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">unmarshall</span><span class="token punctuation">(</span>
        record<span class="token punctuation">.</span>dynamodb<span class="token punctuation">.</span>NewImage
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> originalRecord <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">unmarshall</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>dynamodb<span class="token punctuation">.</span>OldImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>potentiallyChangedRecord<span class="token punctuation">.</span>aws_vulnerabilities<span class="token punctuation">)</span> <span class="token operator">!==</span>
        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>originalRecord<span class="token punctuation">.</span>aws_vulnerabilities<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SLACK_ENDPOINT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          text<span class="token punctuation">:</span> util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
            <span class="token string">"_Vulnerabilities Changed_ for *%s* with SHA *%s* tagged *%s* \n ```%s```"</span><span class="token punctuation">,</span>
            potentiallyChangedRecord<span class="token punctuation">.</span>repository<span class="token punctuation">,</span>
            potentiallyChangedRecord<span class="token punctuation">.</span>sha_digest<span class="token punctuation">,</span>
            potentiallyChangedRecord<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>potentiallyChangedRecord<span class="token punctuation">.</span>aws_vulnerabilities<span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>When changes are detected to either a new image or to an existing image, a Slack message notifying there are vulnerabilities for a given image will be sent. </p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 18.378995433789953%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAx0lEQVQY02WPSRaCMBBEuYYyhClMAgJhSBjdufAMbr3/DcoOD9m4+K86qXRX2hDrE1GcIcsr5GWDOC2QZCUCnoJ5HKbt4Wq5p15M9sfpE8br/YFoOqhpI1aoccW0PCBJ216hFgOaVpL2KO4CIQXxKNsDvSBGECawHH8fqjF8n6OTM5pO7ipoSDtMVE8YxoXuFaQOmjfyxt3r1YKybpEWFW60lccTMD+CSwGGxQI4bgibcGhF+6jPs/ZJ2eE5B7rPpJ9p9JtfzxdZt3aRwcRUiQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/0d66df900c4c131f7d86010439f8634e/cc182/slack-message.webp 148w,
/static/0d66df900c4c131f7d86010439f8634e/f7e40/slack-message.webp 295w,
/static/0d66df900c4c131f7d86010439f8634e/1a2f4/slack-message.webp 590w,
/static/0d66df900c4c131f7d86010439f8634e/4837b/slack-message.webp 885w,
/static/0d66df900c4c131f7d86010439f8634e/2f819/slack-message.webp 1180w,
/static/0d66df900c4c131f7d86010439f8634e/279f6/slack-message.webp 1752w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/0d66df900c4c131f7d86010439f8634e/cf440/slack-message.png 148w,
/static/0d66df900c4c131f7d86010439f8634e/d2d38/slack-message.png 295w,
/static/0d66df900c4c131f7d86010439f8634e/b9e4f/slack-message.png 590w,
/static/0d66df900c4c131f7d86010439f8634e/f9b6a/slack-message.png 885w,
/static/0d66df900c4c131f7d86010439f8634e/2d849/slack-message.png 1180w,
/static/0d66df900c4c131f7d86010439f8634e/53edc/slack-message.png 1752w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/0d66df900c4c131f7d86010439f8634e/b9e4f/slack-message.png"
          alt="Slack"
          title="Slack Message"
          loading="lazy"
        />
      </picture>
    </span></p>
<p>You can now decide on your own if the vulnerabilities detected are worth investigating. If you go to AWS‚Äôs console and inspect the image you were notified of, you can see a list of all the vulnerabilities and their corresponding CVEs</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 32.58088788562829%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABKElEQVQoz3VRu07DMBT1zzFTKj6AP2JLYONLKlQVsRQQFVSAGAKFAYmQNLHjR2wfrh03ZWE4Oi/fO1yzsixhjIHWBkZrYh15yPZe/9PFzOyZlacH2J4fo84mqPIJ6rMp6vwIVZZ08hF/u3zXTWmOuuwQzcUJmHq9hv9cQaxnEC9XpO/RPC/wvZrBbm5h3pb4ebiEKZZwm7uo6/V89NXjHM3TAvb9BvZjBcYNoBwgCcoDGkBnBwQdMtGTTl1875P3wftxLnhWFAXCHbVSULIboCR5SVqOfsdGq5QPb4LXqZcEFktaFg8cjp0OLjp6QPn4AcRCCHDOx6yj2aZpaZGMXkoF9tVIcNXDOwdrbYQj3bYcdb0dM+8dOC1saaH3PmZ936PrZOQwE/ALix0IGio0oekAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/6df4a77277bbafb20a42a2675d19a7eb/cc182/cve.webp 148w,
/static/6df4a77277bbafb20a42a2675d19a7eb/f7e40/cve.webp 295w,
/static/6df4a77277bbafb20a42a2675d19a7eb/1a2f4/cve.webp 590w,
/static/6df4a77277bbafb20a42a2675d19a7eb/4837b/cve.webp 885w,
/static/6df4a77277bbafb20a42a2675d19a7eb/2f819/cve.webp 1180w,
/static/6df4a77277bbafb20a42a2675d19a7eb/c8dd7/cve.webp 2658w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/webp"
        />
        <source
          srcset="/static/6df4a77277bbafb20a42a2675d19a7eb/cf440/cve.png 148w,
/static/6df4a77277bbafb20a42a2675d19a7eb/d2d38/cve.png 295w,
/static/6df4a77277bbafb20a42a2675d19a7eb/b9e4f/cve.png 590w,
/static/6df4a77277bbafb20a42a2675d19a7eb/f9b6a/cve.png 885w,
/static/6df4a77277bbafb20a42a2675d19a7eb/2d849/cve.png 1180w,
/static/6df4a77277bbafb20a42a2675d19a7eb/b7cb3/cve.png 2658w"
          sizes="(max-width: 590px) 100vw, 590px"
          type="image/png"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/6df4a77277bbafb20a42a2675d19a7eb/b9e4f/cve.png"
          alt="Vulnerabilities"
          title="Vulnerabilities"
          loading="lazy"
        />
      </picture>
    </span></p>
<h2 id="putting-all-together"><a href="#putting-all-together" aria-label="putting all together permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Putting all together.</h2>
<p>In this post we have mostly concentrated on the lambda code required to create the components. Apart from the Lambda code, the GitHub repo also contains the Infrastructure Code (Iac) required to create the resources in AWS in order to glue them together. Just follow th instruction smentioned in this repo and you should have your docker images scanner up in minutes.</p>
<p><asciinema-player src="/2020/02/14/ecr-scanning-notifier/aws-ecr-notify.json"
  cols="180" rows="15" autoplay="true" loop="true" speed="2.0">
</asciinema-player></p>
<p>For the purposes of this post, we used Slack. But the way the Lambda function is built, it could really be any HTTP endpoint, meaning you could even notify your internal systems of potential vulnerability changes in a Docker image.</p></div></section></article></main></div><footer class="Footer__FooterWrapper-sc-1oxe0wr-0 hFicPH"><nav><div class="footer-col"><h5 class="footer-title">040 code ¬© 2019</h5><span class="footer-item">Build with <i></i><a class="footer-link" href="https://www.gatsbyjs.org/">Gatsby</a></span></div><div class="footer-col"><h5 class="footer-title">Blog</h5><span class="footer-item"><a class="footer-link" href="/">home</a></span><span class="footer-item"><a class="footer-link" href="/about">about</a></span></div><div class="footer-col"><h5 class="footer-title">Source</h5><span class="footer-item"><i></i><a class="footer-link" href="https://github.com/040code/">Github</a></span></div></nav></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97020149-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020/02/14/ecr-scanning-notifier";window.webpackCompilationHash="4a86779ccf4d1b44ab75";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-5643697e2de9bcce0385.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-c4fe219a301439484a06.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-3478508ec23c2934e4f1.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-658161403c49a8a1208a.js"],"component---src-templates-page-js":["/component---src-templates-page-js-7e7e89f412e118251bb2.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-5a23d2283ad3d5c31166.js"],"component---src-templates-authors-js":["/component---src-templates-authors-js-c6344b2044878ea20b55.js"],"component---src-pages-404-js":["/component---src-pages-404-js-97ff63f7f4b2c8c3c88f.js"]};/*]]>*/</script><script src="/webpack-runtime-13449825e32741877b57.js" async=""></script><script src="/commons-34dc266fc00251e3bca6.js" async=""></script><script src="/component---src-templates-blog-post-js-658161403c49a8a1208a.js" async=""></script><script src="/app-5643697e2de9bcce0385.js" async=""></script></body></html>