<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"/><style data-href="/styles.131b48b25a50eff60b34.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><meta name="generator" content="Gatsby 2.3.35"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="hTmxqc lcZENV lfoWPa hPmQYh dANmgz brBAvj hpDnww bWPqAN hwkicN iTdcdb jRHVYT kQWgFX itRnbT uzIVo hFicPH" data-styled-version="4.2.0">
/* sc-component-id: SideMenu__StyledBurgerMenu-uekpe8-0 */
.hTmxqc .bm-burger-button{position:fixed;width:36px;height:30px;left:36px;top:36px;} .hTmxqc .bm-burger-bars{background:#ffffff;} .hTmxqc .bm-cross-button{height:24px;width:24px;} .hTmxqc .bm-cross{background:#ffffff;} .hTmxqc .bm-menu{background:rgb(0,0,0,0.5);padding:2.5em 1em 0;font-size:1.15em;} .hTmxqc .bm-morph-shape{fill:#373a47;} .hTmxqc .bm-item-list{padding-top:2em;} .hTmxqc .bm-item{display:inline-block;padding:0.5em;} .hTmxqc .bm-overlay{background:rgba(0,0,0,0.3);}
/* sc-component-id: SideMenu__MenuLink-uekpe8-1 */
.lcZENV{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#fff;border:0;margin:0;margin-right:0.5rem;padding-left:20px;padding-right:20px;min-width:42px;z-index:10;}
/* sc-component-id: Footer__FooterWrapper-sc-1oxe0wr-0 */
.hFicPH{text-align:left;padding-top:30px;padding-bottom:50px;background-color:rgba(32,35,42,0.85);color:#ffffff;padding-left:20px;padding-right:20px;margin:3.5em auto 0 0;} .hFicPH nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;} .hFicPH nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-bottom:1em;padding-right:1em;} .hFicPH a{color:#ffffff;font-weight:bold;} .hFicPH a:hover{color:#e8e8e8;border-bottom:1px dotted #e8e8e8;} .hFicPH .footer-col > p{margin:0;} .hFicPH .footer-title{margin:0 0 1rem;} .hFicPH .footer-item{padding:0.25rem 0;color:#ffffff;} .hFicPH .footer-heart{color:red;} .hFicPH .footer-item-text{padding:0.1rem 0;color:#ffffff;} .hFicPH .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;} @media (max-width:564px){.hFicPH .footer-col:first-child{width:100%;}}
/* sc-component-id: sc-global-3886539976 */
*{box-sizing:border-box;margin:0;padding:0;} body{font-family:"Lato",sans-serif;color:#222222cc;background-color:#e8e8e8;} img{max-width:100%;height:auto;vertical-align:middle;border:0;} a{-webkit-text-decoration:none;text-decoration:none;color:rgba(34,34,34,0.8);} ul,ol{padding-left:2em;margin:1em 0 0 0;}
/* sc-component-id: Wrapper-aej7i5-0 */
.hwkicN{position:relative;border-radius:3px;width:80%;max-width:770px;border-bottom:1px solid #ebf2f6;word-wrap:break-word;background-color:#fff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);} @media (max-width:780px){.hwkicN{width:90%;padding:25px;}}
/* sc-component-id: Hero__HeroContainer-sc-1i1rqpz-0 */
.lfoWPa{position:relative;display:table;width:100%;height:340px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}
/* sc-component-id: Hero__TitleContainer-sc-1i1rqpz-1 */
.hPmQYh{display:table-cell;vertical-align:middle;text-align:center;width:100%;}
/* sc-component-id: Hero__HeroTitle-sc-1i1rqpz-3 */
.dANmgz{font-size:3.5rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-weight:800;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__HeroSubtitle-sc-1i1rqpz-4 */
.brBAvj{font-size:1.7rem;margin:10px 60px;color:#fff;text-shadow:2px 2px #222222;font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;}
/* sc-component-id: Hero__DateAndAuthor-sc-1i1rqpz-5 */
.hpDnww{font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;}
/* sc-component-id: Hero__AuthorLink-sc-1i1rqpz-6 */
.bWPqAN{margin-left:0.3rem;font-weight:500;font-size:1.2rem;color:#fff;text-shadow:2px 2px #222222;} .bWPqAN:hover{border-bottom:1px dotted #787676;} .bWPqAN:before{content:'@';}
/* sc-component-id: TagList__ListContainer-sc-1uj42o2-0 */
.kQWgFX{display:inline;margin:0 0.5rem 0 0;color:#787676;}
/* sc-component-id: TagList__TagListItem-sc-1uj42o2-1 */
.itRnbT{margin-left:0.3rem;display:inline-block;min-width:10px;padding:3px 7px;font-size:12px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#777;border-radius:10px;} .itRnbT:hover{border-bottom:1px dotted #787676;}
/* sc-component-id: ContentHeader__Header-sc-1uw779c-0 */
.jRHVYT{margin-bottom:2rem;color:#787676;}
/* sc-component-id: Content__ContentBody-sc-1jppj8x-0 */
.uzIVo{line-height:1.6;} .uzIVo > h2:first-of-type{padding-top:0;} .uzIVo > h2{padding-top:3rem;margin-top:3rem;border-top:1px solid #ececec;} .uzIVo > h3:first-of-type{padding-top:0;} .uzIVo > h3{padding-top:3rem;} .uzIVo > p{margin:1em 0 0 0;} .uzIVo a{border-bottom:1px dotted rgba(162,162,162,0.8);} .uzIVo a:hover{border-bottom-style:solid;} .uzIVo a.anchor,.uzIVo a.gatsby-resp-image-link{border:none;} .uzIVo > blockquote{box-sizing:border-box;margin:1.75em 0 1.75em -2.2em;padding:0 0 0 1.75em;border-left:0.4em solid rgba(32,35,42,0.85);} .uzIVo > blockquote p{margin:0.8em 0;font-style:italic;} .uzIVo .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;background:#2d2d2d;color:#ffffff;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em 0em 1.5em 0;font-size:0.7em;} .uzIVo .gatsby-highlight > pre{border:0;margin:0;padding:1;} .uzIVo .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffa7c4;} .uzIVo p > code.language-text,.uzIVo li > code.language-text{background:rgba(255,229,100,0.2);color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;} .uzIVo table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;} .uzIVo table th,.uzIVo table td{padding:0.5em;background:#e8e8e8;border-bottom:2px solid white;}
/* sc-component-id: Article__ArticleWrapper-sc-1nyoqfc-0 */
.iTdcdb{padding:0 30px 30px;} @media only screen and (max-width:500px){.iTdcdb{padding:0;}}</style><title data-react-helmet="true">Coding a VPC in Terraform | 040code</title><link data-react-helmet="true" rel="canonical" href="https://040code.github.io/2017/06/18/coding-a-vpc-in-terraform"/><meta data-react-helmet="true" name="description" content="One of the common uses network setups in AWS is called Scenario 2: VPC with Public and Private Subnets. This is a that defines a Virtual‚Ä¶"/><meta data-react-helmet="true" property="og:url" content="https://040code.github.io/2017/06/18/coding-a-vpc-in-terraform"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Coding a VPC in Terraform | 040code"/><meta data-react-helmet="true" property="og:description" content="One of the common uses network setups in AWS is called Scenario 2: VPC with Public and Private Subnets. This is a that defines a Virtual‚Ä¶"/><meta data-react-helmet="true" property="og:image" content="https://040code.github.io/static/2017-06-18-coding-a-vpc-in-terraform-fb-863703b2009a9211abe4b344e40f6394.png"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="niekos77"/><meta data-react-helmet="true" name="twitter:title" content="Coding a VPC in Terraform | 040code"/><meta data-react-helmet="true" name="twitter:description" content="One of the common uses network setups in AWS is called Scenario 2: VPC with Public and Private Subnets. This is a that defines a Virtual‚Ä¶"/><meta data-react-helmet="true" name="twitter:image" content="https://040code.github.io/static/2017-06-18-coding-a-vpc-in-terraform-tw-77c0dbeee7969dd37c02e1b493b0555c.png"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=008654519ce705ac7bc44303a9014606"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-d3585b476d6c86bf0aca.js"/><link as="script" rel="preload" href="/app-715171e8e5cdae933bb8.js"/><link as="script" rel="preload" href="/12-cbf59fa61e7940293698.js"/><link as="script" rel="preload" href="/1-0ce5f04e72721174a55a.js"/><link as="script" rel="preload" href="/styles-13d2ee47eddc5325ccbc.js"/><link as="script" rel="preload" href="/webpack-runtime-49d3386b1fb533fa1cd9.js"/><link as="fetch" rel="preload" href="/static/d/432/path---2017-06-18-coding-a-vpc-in-terraform-504-ea7-x4P6wJCTqInaGlMVbJUwTchUw68.json" crossorigin="use-credentials"/></head><body><noscript>This site runs best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="SideMenu__StyledBurgerMenu-uekpe8-0 hTmxqc"><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/">üè° 040 blog</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/niek">Niek Palm</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/maarten">Maarten Metz</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/jeroen">Jeroen Knoops</a><a class="bm-item SideMenu__MenuLink-uekpe8-1 lcZENV" style="display:block" tabindex="-1" href="/authors/stefan">Stefan van den Oord</a></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><span style="position:absolute;top:6px;right:14px"><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(45deg)"></span><span class="bm-cross" style="position:absolute;width:3px;height:14px;transform:rotate(-45deg)"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:0%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:40%;opacity:1"></span><span class="bm-burger-bars" style="position:absolute;height:20%;left:0;right:0;top:80%;opacity:1"></span></span><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></div><div style="margin:0 0"><div style="background-image:url(&quot;/static/piazza-4e7cab4e75f74c20f03a8b093b0c4b34.jpg&quot;)" class="Hero__HeroContainer-sc-1i1rqpz-0 lfoWPa"><div class="Hero__TitleContainer-sc-1i1rqpz-1 hPmQYh"><h1 class="Hero__HeroTitle-sc-1i1rqpz-3 dANmgz">Coding a VPC in Terraform</h1><h2 class="Hero__HeroSubtitle-sc-1i1rqpz-4 brBAvj">A terraform module for a VPC with Private Subnets</h2><span class="Hero__DateAndAuthor-sc-1i1rqpz-5 hpDnww">by:<!-- --> <a class="Hero__AuthorLink-sc-1i1rqpz-6 bWPqAN" href="/authors/niek">niek</a>¬† on <!-- -->2017-06-18</span></div></div><main role="main" class="Wrapper-aej7i5-0 hwkicN"><article class="Article__ArticleWrapper-sc-1nyoqfc-0 iTdcdb"><section><header class="ContentHeader__Header-sc-1uw779c-0 jRHVYT"><div class="TagList__ListContainer-sc-1uj42o2-0 kQWgFX"><a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/aws">aws</a> <a class="w3-round-size TagList__TagListItem-sc-1uj42o2-1 itRnbT" href="/tags/terraform">terraform</a></div></header><div class="Content__ContentBody-sc-1jppj8x-0 uzIVo"><p>One of the common uses network setups in AWS is called <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario2.html">Scenario 2: VPC with Public and Private Subnets</a>. This is a that defines a Virtual Private Cloud (VPC), public subnets and private subnets. Setting up this infrastructure can be done via the AWS console or via cloud formation scripting. However, I prefer the tool <a href="https://www.terraform.io/">Terraform</a> in which you can manage your infrastructure as code with a declarative language that supports building, changing and versioning your cloud in a modular way.</p>
<p>In this article I will describe how you can create a VPC with a public and private subnet on AWS using terraform. I will describe the setup step by step and I will show how to encapsulate all logic to one re-usable module.</p>
<blockquote>
<p><a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Subnets.html">Why we need subnets.</a> When you create a VPC, it spans all the Availability Zones in the region. After creating a VPC, you can add one or more subnets in each Availability Zone. When you create a subnet, you specify the CIDR block for the subnet, which is a subset of the VPC CIDR block. Each subnet must reside entirely within one Availability Zone and cannot span zones. Availability Zones are distinct locations that are engineered to be isolated from failures in other Availability Zones. By launching instances in separate Availability Zones, you can protect your applications from the failure of a single location.</p>
</blockquote>
<p>Before you can start, you need an AWS account with sufficient rights (admin), and you should create a <code class="language-text">AWS_ACCESS_KEY_ID</code> and <code class="language-text">AWS_SECRET_ACCESS_KEY</code> to be able to access your account programmatically.</p>
<h2 id="setting-up-your-system"><a href="#setting-up-your-system" aria-label="setting up your system permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up your system.</h2>
<p>The easiest way to use terraform is via docker. In that case you do not need any locally isntalled tools. We simply create a file called <code class="language-text">.aws</code> where we put the AWS key and secret to athentication API calls, as shown below:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">AWS_ACCESS_KEY_ID=&lt;KEY&gt;
AWS_SECRET_ACCESS_KEY=&lt;SECRET&gt;</code></pre></div>
<h2 id="creating-a-vpc-part-1"><a href="#creating-a-vpc-part-1" aria-label="creating a vpc part 1 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a VPC part 1</h2>
<p>All code for part 1 is available on <a href="https://github.com/040code/blog_terraform-aws-vpc">github</a></p>
<p>By default, terraform expects the configuration in a file called <code class="language-text">main.tf</code>. Create the file and add the terraform provide for Amazon:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"># main.tf
provider &quot;aws&quot; {
  region = &quot;eu-west-1&quot;
}</code></pre></div>
<p>We are now ready to, step-by-step, add the terraform resources to create the VPC setup. First, have a look on the VPC setup as shown in the picture below.
<a href="#">
<span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.74525745257452%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAClUlEQVQ4y4VU227TQBD1V/LEF/Al/AM/AI8ICShIIEQELbmUpLm5pEnaNI6dxnd77d21fZjZtFEkoKw0sj1enzl7zowt0BLnHyEGnyGzEGVZ3oc8ihJSSiilUFUVmqb5Z1h1XaMUOQpvAXH2CrIQ+2AQcy2guADda0WgBPzYslA3oF3w73wM+xNKNZA1IEUGWdXErIQqcmhZoKJQVDwXAr7vw57amF/NcWnb8DwPgvKWVCUKkcKPAyRFAblzkHbfQhG0XrbRxBsoqpkTEB83jUK4rotOp4Pvp6dYr9dYLhbodXvm3pq4E1ys+jiZfkDvaoBZvwfv+RMUNyPctV/DGX9DTMeOqKAmDcssNky20RZu6JIUJZIkgRt5SLMUltbSMAySEFor5GSCt3FwffMLq3CH2WaBdeQiJTAiahRi8Y8XP9dN/aBhjZp0KqgSu8jLDwIMR2NEQWieFTEp5m1oAq7sLyY3mUwxuBgeAHFfiFymNiCWWzLlZ29oQLlNWK+qFigbhXA5gvf1JYLlGLfvX0AojdFohLMf7T/YWg0x1KRRngtwC/FitmkS4FNric7ANblEUMuQ67ng0xQmF8cxHMcxoSttSBwAWeiHagy+9W7x5uQST5+9I9as895lmSWmRbqdLlqtFubzOWazGc5753uXDwwJ0OhhAHOEUYQg2OF2vSX3ciMDy5HFoXH12rnGYr1ATu/cnQt7ZWNz5x4zLMjlPW12eTYdI0tiU4TdZ7CadaW9FR1dV5SrOEeTRr2cSRoE8sIAyjw1k6FLYcB1GmJ3NUZJlRXleUI0jZ6ZmLJ4fPTYCK7OwQz5mY80pXEKwpCcrk1eMkNqQt73/5/DfZvwh+Zj+gGsVivj4nH+4d2h9/6yfgM2gX0ML7ZrjwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;"></span>
    <picture>
        <source srcset="/static/8b78637f33297f5081063556e8f76152/cc182/nat-gateway-diagram.webp 148w,
/static/8b78637f33297f5081063556e8f76152/f7e40/nat-gateway-diagram.webp 295w,
/static/8b78637f33297f5081063556e8f76152/1a2f4/nat-gateway-diagram.webp 590w,
/static/8b78637f33297f5081063556e8f76152/4eead/nat-gateway-diagram.webp 738w" sizes="(max-width: 590px) 100vw, 590px" type="image/webp">
        <source srcset="/static/8b78637f33297f5081063556e8f76152/cf440/nat-gateway-diagram.png 148w,
/static/8b78637f33297f5081063556e8f76152/d2d38/nat-gateway-diagram.png 295w,
/static/8b78637f33297f5081063556e8f76152/b9e4f/nat-gateway-diagram.png 590w,
/static/8b78637f33297f5081063556e8f76152/2bf51/nat-gateway-diagram.png 738w" sizes="(max-width: 590px) 100vw, 590px" type="image/png">
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;" src="/static/8b78637f33297f5081063556e8f76152/b9e4f/nat-gateway-diagram.png" alt="nat-gateway-diagram" title>
      </picture>
  </span>
</a></p>
<p>We will start by creating the VPC itself: add the following snippet to your <code class="language-text">main.tf</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_vpc&quot; &quot;vpc&quot; {
  cidr_block           = &quot;10.0.0.0/16&quot;
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags {
    label = &quot;blog&quot;
  }
}</code></pre></div>
<p>Before we make the change effective we run a <code class="language-text">terraform plan</code> to inspect the planned changes. You can install terraform locally or run the commands in a docker container. The docker command will export the AWS credentials to the container, mount the current directory to <code class="language-text">/data</code> in the container, and set <code class="language-text">/data</code> as working directory to ensure the container will execute the <code class="language-text">terraform plan</code> command on the directory that contains the terraform files.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker run -it --env-file ./.aws  -v $(pwd):/data -w /data \
  hashicorp/terraform:0.9.8 plan</code></pre></div>
<p>After executing the plan command, you should see output similar to:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">+ aws_vpc.vpc
    assign_generated_ipv6_cidr_block: &quot;false&quot;
    cidr_block:                       &quot;10.0.0.0/16&quot;
    default_network_acl_id:           &quot;&lt;computed&gt;&quot;
    default_route_table_id:           &quot;&lt;computed&gt;&quot;
    default_security_group_id:        &quot;&lt;computed&gt;&quot;
    dhcp_options_id:                  &quot;&lt;computed&gt;&quot;
    enable_classiclink:               &quot;&lt;computed&gt;&quot;
    enable_dns_hostnames:             &quot;true&quot;
    enable_dns_support:               &quot;true&quot;
    instance_tenancy:                 &quot;&lt;computed&gt;&quot;
    ipv6_association_id:              &quot;&lt;computed&gt;&quot;
    ipv6_cidr_block:                  &quot;&lt;computed&gt;&quot;
    main_route_table_id:              &quot;&lt;computed&gt;&quot;
    tags.%:                           &quot;1&quot;
    tags.label:                       &quot;blog&quot;


Plan: 1 to add, 0 to change, 0 to destroy.</code></pre></div>
<p>This looks correct, so we can apply the change to create the VPC by running <code class="language-text">terraform apply</code>.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker run -it --env-file ./.aws  -v $(pwd):/data -w /data \
  hashicorp/terraform:0.9.8 apply</code></pre></div>
<p>You can go VPC via the AWS console, where you should now see a VPC in the list named <code class="language-text">blog</code>. Now we have the VPC, we create a public and private subnet by adding the following to the main.tf.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_subnet&quot; &quot;public_subnet_a&quot; {
  vpc_id                  = &quot;${aws_vpc.vpc.id}&quot;
  cidr_block              = &quot;10.0.0.0/24&quot;
  availability_zone       = &quot;eu-west-1a&quot;
  map_public_ip_on_launch = false

  tags {
    Name = &quot;blog&quot;
  }
}

resource &quot;aws_subnet&quot; &quot;private_subnet_a&quot; {
  vpc_id                  = &quot;${aws_vpc.vpc.id}&quot;
  cidr_block              = &quot;10.0.1.0/24&quot;
  availability_zone       = &quot;eu-west-1a&quot;

  tags {
    Name = &quot;blog&quot;
  }
}</code></pre></div>
<p>Run now <code class="language-text">terraform plan</code> again, it will show that the resources will be added, one for each subnet. Apply the change using <code class="language-text">terraform apply</code> and inspect your changes again via the VPC section in the AWS console.</p>
<p>Next, we connect the public subnet via an <em>internet gateway</em>. Create a routing table and an internet gateway. And a <em>aws<em>route</em>table_association</em> to create an association between a subnet and routing table. Update your <code class="language-text">main.tf</code> with the snippet below, and run a plan and apply.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_internet_gateway&quot; &quot;internet_gateway&quot; {
  vpc_id = &quot;${aws_vpc.vpc.id}&quot;
}

resource &quot;aws_route_table&quot; &quot;public_routetable&quot; {
  vpc_id = &quot;${aws_vpc.vpc.id}&quot;

  route {
    cidr_block = &quot;0.0.0.0/0&quot;
    gateway_id = &quot;${aws_internet_gateway.internet_gateway.id}&quot;
  }

  tags {
    label = &quot;blog&quot;
  }
}

resource &quot;aws_route_table_association&quot; &quot;public_subnet_a&quot; {
  subnet_id      = &quot;${aws_subnet.public_subnet_a.id}&quot;
  route_table_id = &quot;${aws_route_table.public_routetable.id}&quot;
}</code></pre></div>
<p>We are now able to deploy an application to the public subnet and make it accessible via a security group. However, it is not yet possible to route traffic to the private subnet or let instances on the private subnet connect to internet. To do so, we add a NAT gateway and connect the gateway via a route table to the private subnet. The NAT gateway requires an elastic IP, which we will create first. Add the next terraform snippet to your <code class="language-text">main.tf</code> and run a <code class="language-text">plan</code> and <code class="language-text">apply</code> to inspect and make the changes effective.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">resource &quot;aws_eip&quot; &quot;nat&quot; {
  vpc = true
}

resource &quot;aws_nat_gateway&quot; &quot;nat&quot; {
  allocation_id = &quot;${aws_eip.nat.id}&quot;
  subnet_id     = &quot;${aws_subnet.public_subnet_a.id}&quot;
}

resource &quot;aws_route_table&quot; &quot;private_routetable&quot; {
  vpc_id = &quot;${aws_vpc.vpc.id}&quot;

  route {
    cidr_block     = &quot;0.0.0.0/0&quot;
    nat_gateway_id = &quot;${aws_nat_gateway.nat.id}&quot;
  }

  tags {
    label = &quot;blog&quot;
  }
}

resource &quot;aws_route_table_association&quot; &quot;private_subnet_a&quot; {
  subnet_id      = &quot;${aws_subnet.private_subnet_a.id}&quot;
  route_table_id = &quot;${aws_route_table.private_routetable.id}&quot;
}</code></pre></div>
<p>Setting up the VPC with subnets is quite verbose, and imagine then when you must support more availability zones, the code will almost double per zone. So we refactor it to a generic module to support the multiple subnets that are available in a zone.</p>
<h2 id="creating-a-vpc-part-2"><a href="#creating-a-vpc-part-2" aria-label="creating a vpc part 2 permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a VPC part 2</h2>
<p>I have rewritten the code showed above to a generic module. With this model, it is easy to create a VPC with all availability zones per zone, and private subnets can be enabled on demand.</p>
<blockquote>
<p><a href="https://www.terraform.io/docs/modules/usage.html">Modules in terraform</a> are self-contained packages of gerraform configurations that are managed as a group. Modules are used to create reusable components, improve organization, and to treat pieces of infrastructure as a black box.</p>
</blockquote>
<p>I will not describe all code in the module again but only will pay attention to the significant changes I made. In the code above the zone, availability zone where hard coded. This will not work in a generic module. A common way to solve this in terraform is by creating a map where a zone is mapped to a list of availability zondes. By passing the zone to the moudle, the module can find out which availability zones there are. A default map is available in the module but can be ovewritten as follow:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">availability_zones = {
  eu-west-1 = [&quot;eu-west-1a&quot;, &quot;eu-west-1b&quot;, &quot;eu-west-1c&quot;]
}</code></pre></div>
<p>The cdir block in the code show above was hard coded, but terraform contains a function to calculate the cdir block. In the module I use the terraform <a href="https://www.terraform.io/docs/configuration/interpolation.html#cidrsubnet-iprange-newbits-netnum-">function</a> <code class="language-text">cidrsubnet()</code> to calculate the cdir block.</p>
<p>Now only one problem needs to be solved in order to create a generic module: how can we create a AWS resource for each element in a list? Do we create subnet or route table association for each availability zone? Or how can we avoid creating a private subnet at all? The solution is to use the <code class="language-text">count</code> variable in a module to iterate over the list of availability zones, which is available on my <a href="https://github.com/npalm/tf-aws-vpc.git">github</a>. We can now create a VPC similar to the one above with just a few line of code. Add the following lines to your terraform script to create a VPC.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">module &quot;vpc&quot; {
  source = &quot;git::https://github.com/npalm/tf-aws-vpc.git&quot;

  key        = &quot;blog&quot;
  aws_region = &quot;eu-west-1&quot;
}</code></pre></div>
<p>It is possible to overwrite module variables with default to get more control, see the ezample below:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">module &quot;vpc&quot; {
  source = &quot;git::https://github.com/npalm/tf-aws-vpc.git&quot;

  key        = &quot;blog&quot;
  aws_region = &quot;eu-west-1&quot;

  create_private_hosted_zone = &quot;false&quot;
  create_private_subnets     = &quot;false&quot;
  cidr_block = &quot;10.0.0.0/16&quot;

  // example to override default availability_zones
  availability_zones = {
    eu-west-1 = [&quot;eu-west-1a&quot;, &quot;eu-west-1c&quot;]
  }
}</code></pre></div></div></section></article></main></div><footer class="Footer__FooterWrapper-sc-1oxe0wr-0 hFicPH"><nav><div class="footer-col"><h5 class="footer-title">040 code ¬© 2019</h5><span class="footer-item">Buildt with <i></i><a class="footer-link" href="https://www.gatsbyjs.org/">Gatsby</a></span></div><div class="footer-col"><h5 class="footer-title">Blog</h5><span class="footer-item"><a class="footer-link" href="/">home</a></span><span class="footer-item"><a class="footer-link" href="/about">about</a></span></div><div class="footer-col"><h5 class="footer-title">Source</h5><span class="footer-item"><i></i><a class="footer-link" href="https://github.com/040code/">Github</a></span></div></nav></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97020149-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2017-06-18-coding-a-vpc-in-terraform-504","path":"/2017/06/18/coding-a-vpc-in-terraform"};window.dataPath="432/path---2017-06-18-coding-a-vpc-in-terraform-504-ea7-x4P6wJCTqInaGlMVbJUwTchUw68";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-715171e8e5cdae933bb8.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-368195141fa42f7ac926.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-c731dbdbd2c1d3ac0ca7.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-d3585b476d6c86bf0aca.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-c38f6120b6c471d68560.js"],"component---src-templates-authors-js":["/component---src-templates-authors-js-63378b91d8ce3776815c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-74e4d98cf600ca3e6d71.js"],"pages-manifest":["/pages-manifest-3bcd0cd5ebb6b849d2ce.js"]};/*]]>*/</script><script src="/webpack-runtime-49d3386b1fb533fa1cd9.js" async=""></script><script src="/styles-13d2ee47eddc5325ccbc.js" async=""></script><script src="/1-0ce5f04e72721174a55a.js" async=""></script><script src="/12-cbf59fa61e7940293698.js" async=""></script><script src="/app-715171e8e5cdae933bb8.js" async=""></script><script src="/component---src-templates-blog-post-js-d3585b476d6c86bf0aca.js" async=""></script></body></html>